sap.ui.define(["ndbs/ui/vehiclemanagementui/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","ndbs/ui/vehiclemanagementui/model/formatter","sap/m/MessageToast","sap/ui/model/Sorter"],function(e,t,n,s,o,i,r){let a="batchRequest";"use strict";return e.extend("ndbs.ui.vehiclemanagementui.controller.Homepage",{formatter:o,onInit:function(){let e=this.getView(),t=sap.ui.getCore().getMessageManager();this.getOwnerComponent().getModel("generalJsonModel").setProperty("/busy",true);e.byId("dpPeriod").setDateValue(new Date);e.setModel(t.getMessageModel(),"message");t.registerObject(e,true)},onAfterRendering:function(){this._getUserVehicleData()},_getUserVehicleData:async function(){await this._getUserInfo();let e=await this._getPersonnelInfo();if(e){this._getExpenses()}},_getUserInfo:function(){let e=this.getOwnerComponent().getManifestEntry("/sap.app/id"),n=e.replaceAll(".","/"),s=`${jQuery.sap.getModulePath(n)}/user-api/currentUser`,o=new t;return new Promise((e,t)=>{o.loadData(s);o.dataLoaded().then(()=>{if(!o.getData().email){let e={firstname:"Hasan",lastname:"Çiftçi",email:"hasan.ciftci@nttdata.com",name:"hasan.ciftci@nttdata.com",displayName:"Hasan Çiftçi (hasan.ciftci@nttdata.com)"};o.setData(e)}this.getView().setModel(o,"userInfo");e()})})},_getPersonnelInfo:function(){let e=this.getView().getModel("userInfo").getProperty("/email"),t=this.getView().getModel("generalJsonModel"),n=this.getResourceBundle(),s=this.getView().byId("dpPeriod");return new Promise((o,i)=>{this.getView().byId("ophcExpensesHeader").bindElement({path:`/PersonnelInformation('${e}')`,parameters:{$select:"*",$expand:"toVehicles($select=*),toProjects"},events:{dataReceived:e=>{let i=e.getSource().getBoundContext().getObject(),r="",a="",g=this._getCurrentPeriod(s.getDateValue()),l=`${g.substring(5,7)}/${g.substring(0,4)}`,u=false,d=true;this._iPersonnelNo=i.personnelNo;if(i.toVehicles){r=n.getText("updatable");a="Success";u=true}else{r=n.getText("noVehicle",[i.personnelNo,l]);a="Error";d=false}t.setProperty("/expenseStatusText",r);t.setProperty("/expenseStatus",a);t.setProperty("/busy",false);t.setProperty("/buttonEnabled",d);o(u)}}})})},_getExpenses:function(){let e=this.getView(),t=e.byId("ophcExpensesHeader").getBindingContext().getProperty("personnelNo"),o=this._getCurrentPeriod(e.byId("dpPeriod").getDateValue()),i=new n({filters:[new n("personnelNo",s.EQ,t),new n("period",s.EQ,o)],and:true}),g=this.getTableTemplate(this),l=this.getView().getModel("generalJsonModel"),u=new r({path:"date",descending:true,group:false});e.byId("tblExpenses").bindItems({path:"/KilometerExpenses",template:g,templateShareable:true,filters:i,sorters:u,parameters:{$select:"*",$$updateGroupId:a},events:{dataReceived:e=>{let t=e.getSource().getCurrentContexts(),n=0,s=0;t.forEach(e=>{if(e){n+=Number(e.getObject().distance);s+=Number(e.getObject().amount)}});l.setProperty("/totalAmount",s.toFixed(2));l.setProperty("/currency_code","TRY");l.setProperty("/totalTrip",n.toFixed(2));l.setProperty("/distanceUnit","KM")}}})},_getCurrentPeriod:function(e=new Date){let t=(e.getMonth()+1).toString().length<2?`0${e.getMonth()+1}`:`${e.getMonth()+1}`,n=e.getFullYear().toString(),s=`${n}-${t}`;return s},_getCurrentDate:function(){let e=new Date,t=e.getDate().toString().length<2?`0${e.getDate().toString()}`:e.getDate().toString(),n=(e.getMonth()+1).toString().length<2?`0${e.getMonth()+1}`:`${e.getMonth()+1}`,s=e.getFullYear().toString();return`${s}-${n}-${t}`},_getMessagePopover:function(){let e=this.getView();if(!this._pMessagePopover){this._pMessagePopover=sap.ui.core.Fragment.load({id:e.getId(),name:"ndbs.ui.vehiclemanagementui.fragments.MessagePopover",controller:this}).then(function(t){e.addDependent(t);return t})}return this._pMessagePopover},_deleteExpenses:function(e){return new Promise(t=>{e.delete("$direct").then(()=>{t()})})},onAddNewRow:function(){this.getView().byId("tblExpenses").getBinding("items").create({personnelNo:this._iPersonnelNo,date:this._getCurrentDate(),distance:0,distanceUnit:"KM",amount:0,currency_code:"TRY",period:this._getCurrentPeriod(this.getView().byId("dpPeriod").getDateValue()),status:"W"})},onChangeDistance:function(e){let t=e.getParameter("newValue"),n=this.getView().byId("ophcExpensesHeader").getBindingContext().getProperty("toVehicles/fuelFactor"),s=t?parseFloat(t.replaceAll(",",".")):0,o=e.getSource().getBindingContext(),i=o.getPath();s*=n;s=s.toFixed(2);o.setProperty(`${i}/amount`,s)},onSaveExpenses:function(){let e=this.getView().getModel(),t=e.hasPendingChanges(),n=this.getView().getModel("generalJsonModel");if(t){n.setProperty("/busy",true);e.submitBatch(a).then(()=>{n.setProperty("/busy",false);if(!this.getView().getModel().hasPendingChanges()){i.show(this.getResourceBundle().getText("savedSuccessfully"))}})}},onMessagePopoverPress:function(e){let t=e.getSource();this._getMessagePopover().then(function(e){e.openBy(t)})},onChangePeriod:function(e){if(this.getView().getModel().hasPendingChanges()){this.getView().getModel().resetChanges(a)}this._getExpenses()},onDuplicateRows:function(){let e=this.getView().byId("tblExpenses"),t=e.getSelectedContexts();if(!t.length){i.show(this.getResourceBundle().getText("atLeastOneRow"));return}t.forEach(t=>{let n=t.getObject();delete n.expenseID;n.status="W";n.period=this._getCurrentPeriod(this.getView().byId("dpPeriod").getDateValue());e.getBinding("items").create(n)})},onDeleteRow:function(){let e=this.getView().byId("tblExpenses"),t=e.getSelectedContexts(),n=[];if(!t.length){i.show(this.getResourceBundle().getText("atLeastOneRow"));return}t.forEach(e=>{n.push(this._deleteExpenses(e))});Promise.all(n).then(()=>{e.getBinding("items").refresh()})},onProjectValueHelpRequest:function(e){this._oProjectInput=e.getSource();if(!this._oProjectValueHelp){this._oProjectValueHelp=sap.ui.core.Fragment.load({id:this.getView().getId(),name:"ndbs.ui.vehiclemanagementui.fragments.ValueHelp",controller:this}).then(function(e){this.getView().addDependent(e);return e}.bind(this))}this._oProjectValueHelp.then(function(e){e.open()})},onValueProjectSearch:function(e){let t=e.getParameter("value"),o=new n("projectName",s.Contains,t);e.getSource().getBinding("items").filter(o)},onValueProjectConfirm:function(e){let t=+e.getParameter("selectedItem").getDescription();this._oProjectInput.setSelectedKey(t)}})});